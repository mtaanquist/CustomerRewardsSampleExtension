name: CI

on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v1    
      - name: Install NavContainerHelper
        run: Install-Module NavContainerHelper -Force
        shell: powershell
      - name: Get module NavContainerHelper
        run: Get-Module NavContainerHelper
        shell: powershell
      - name: Test credentials
        env:
          USERNAME: {{ secrets.BA_USERNAME }}
          PASSWORD: {{ secrets.BA_PASSWORD }}        
        run: echo User: "$USERNAME", pass: "$PASSWORD"
      - name: Set up Business Central container
        env:
          USERNAME: {{ secrets.BA_USERNAME }}
          PASSWORD: {{ secrets.BA_PASSWORD }}
        run: New-NavContainer -accept_eula -containerName bcdev -imageName mcr.microsoft.com/businesscentral/onprem:latest -useBestContainerOS -alwaysPull -auth NavUserPassword -credential ([PSCredential]::new("$USERNAME", (ConvertTo-SecureString -String "$PASSWORD" -AsPlainText -Force))) -updateHosts -doNotExportObjectsToText -enableSymbolLoading
        shell: powershell
      - name: Build application
        env:
          USERNAME: {{ secrets.BA_USERNAME }}
          PASSWORD: {{ secrets.BA_PASSWORD }}    
        run: Compile-AppInBCContainer -containerName bcdev -credential ([PSCredential]::new("$USERNAME", (ConvertTo-SecureString -String "$PASSWORD" -AsPlainText -Force))) -buildProjectFolder "$GITHUB_WORKSPACE"
        
